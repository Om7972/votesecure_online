<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elections - VoteSecure Online</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/custom.css" />
    <link rel="stylesheet" href="../css/output.css" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="../js/auth-utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .election-card {
            transition: all 0.3s ease;
        }

        .election-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-upcoming {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .status-ended {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .type-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            border: 1px solid;
        }

        .type-federal {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .type-state {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .type-local {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .filter-chip {
            transition: all 0.2s ease;
        }

        .filter-chip.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
            color: #a5b4fc;
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-200 min-h-screen">
    <!-- Header -->
    <header class="nav-glass border-b border-white/10 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="flex items-center space-x-2 group">
                        <div
                            class="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-sm shadow-lg">
                            üó≥Ô∏è
                        </div>
                        <span class="text-xl font-bold text-white">VoteSecure<span
                                class="text-indigo-400">Online</span></span>
                    </a>
                </div>
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="#" id="dashboardNavLink"
                        class="text-slate-300 hover:text-white transition-colors">Dashboard</a>
                    <a href="active_elections.html" class="text-indigo-400 font-medium">Elections</a>
                    <a href="voting_history.html" class="text-slate-300 hover:text-white transition-colors">History</a>
                    <a href="election_results.html"
                        class="text-slate-300 hover:text-white transition-colors">Results</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <span class="text-slate-400 text-sm hidden md:block" id="userName">Loading...</span>
                    <div class="relative">
                        <button id="userMenuBtn"
                            class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold">
                            <i class='bx bx-user'></i>
                        </button>
                        <div id="userDropdown"
                            class="hidden absolute right-0 mt-2 w-48 glass-card border border-white/10 rounded-lg shadow-xl py-2">
                            <a href="user_profile_management.html"
                                class="block px-4 py-2 text-slate-300 hover:bg-white/5">Profile</a>
                            <a href="account_settings.html"
                                class="block px-4 py-2 text-slate-300 hover:bg-white/5">Settings</a>
                            <hr class="my-2 border-white/10">
                            <button id="logoutBtn"
                                class="w-full text-left px-4 py-2 text-red-400 hover:bg-white/5">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Elections</h1>
            <p class="text-slate-400">Browse and participate in elections. Filter by status and type.</p>
        </div>

        <!-- Status Tabs -->
        <div class="flex flex-wrap gap-3 mb-6" id="statusTabs">
            <button data-status="active"
                class="tab-btn active px-6 py-3 rounded-xl font-medium flex items-center space-x-2 bg-slate-700/50 border border-white/10">
                <i class='bx bx-check-circle text-lg'></i>
                <span>Active</span>
                <span class="ml-2 px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 text-xs"
                    id="activeCount">0</span>
            </button>
            <button data-status="upcoming"
                class="tab-btn px-6 py-3 rounded-xl font-medium flex items-center space-x-2 bg-slate-700/50 border border-white/10 text-slate-300 hover:border-white/20">
                <i class='bx bx-time-five text-lg'></i>
                <span>Upcoming</span>
                <span class="ml-2 px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs"
                    id="upcomingCount">0</span>
            </button>
            <button data-status="ended"
                class="tab-btn px-6 py-3 rounded-xl font-medium flex items-center space-x-2 bg-slate-700/50 border border-white/10 text-slate-300 hover:border-white/20">
                <i class='bx bx-check-double text-lg'></i>
                <span>Ended</span>
                <span class="ml-2 px-2 py-0.5 rounded-full bg-slate-500/20 text-slate-400 text-xs"
                    id="endedCount">0</span>
            </button>
        </div>

        <!-- Type Filters -->
        <div class="flex flex-wrap gap-2 mb-8" id="typeFilters">
            <button data-type="all"
                class="filter-chip active px-4 py-2 rounded-lg text-sm font-medium bg-slate-700/30 border border-white/10 text-slate-300">
                All Types
            </button>
            <button data-type="federal"
                class="filter-chip px-4 py-2 rounded-lg text-sm font-medium bg-slate-700/30 border border-white/10 text-slate-300 hover:border-red-500/30">
                <i class='bx bx-world mr-1'></i> Federal
            </button>
            <button data-type="state"
                class="filter-chip px-4 py-2 rounded-lg text-sm font-medium bg-slate-700/30 border border-white/10 text-slate-300 hover:border-blue-500/30">
                <i class='bx bx-map mr-1'></i> State
            </button>
            <button data-type="local"
                class="filter-chip px-4 py-2 rounded-lg text-sm font-medium bg-slate-700/30 border border-white/10 text-slate-300 hover:border-emerald-500/30">
                <i class='bx bx-buildings mr-1'></i> Local
            </button>
        </div>

        <!-- Search -->
        <div class="mb-8">
            <div class="relative">
                <i class='bx bx-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl'></i>
                <input type="text" id="searchInput" placeholder="Search elections..."
                    class="w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-white/10 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-indigo-500/50 focus:ring-2 focus:ring-indigo-500/20">
            </div>
        </div>

        <!-- Elections Grid -->
        <div id="electionsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading state -->
            <div class="col-span-full text-center py-12">
                <div
                    class="animate-spin w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4">
                </div>
                <p class="text-slate-400">Loading elections...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <i class='bx bx-calendar-x text-6xl text-slate-500 mb-4'></i>
            <h3 class="text-xl font-semibold text-white mb-2">No Elections Found</h3>
            <p class="text-slate-400">No elections match your current filters.</p>
        </div>
    </main>

    <script>
        let allElections = [];
        let currentStatus = 'active';
        let currentType = 'all';
        const token = localStorage.getItem('token');

        // Authentication check
        if (!token) {
            window.location.href = 'secure_login.html';
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            // Load data
            loadUserData();
            loadElections();

            // Set up event listeners for status tabs
            document.querySelectorAll('#statusTabs .tab-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const status = this.getAttribute('data-status');
                    setStatusFilter(status, this);
                });
            });

            // Set up event listeners for type filters
            document.querySelectorAll('#typeFilters .filter-chip').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const type = this.getAttribute('data-type');
                    setTypeFilter(type, this);
                });
            });

            // Search input handler
            document.getElementById('searchInput').addEventListener('input', renderElections);

            // User menu toggle
            document.getElementById('userMenuBtn').addEventListener('click', function () {
                document.getElementById('userDropdown').classList.toggle('hidden');
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function () {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('userId');
                window.location.href = 'secure_login.html';
            });

            // Close dropdown on outside click
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#userMenuBtn') && !e.target.closest('#userDropdown')) {
                    document.getElementById('userDropdown').classList.add('hidden');
                }
            });
        });

        // Load user data
        async function loadUserData() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                if (data.success && data.user) {
                    document.getElementById('userName').textContent = data.user.name || data.user.email;
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // Load all elections
        async function loadElections() {
            try {
                const activeRes = await fetch('/api/elections?status=active', { headers: { 'Authorization': 'Bearer ' + token } });
                const upcomingRes = await fetch('/api/elections?status=upcoming', { headers: { 'Authorization': 'Bearer ' + token } });
                const endedRes = await fetch('/api/elections?status=ended', { headers: { 'Authorization': 'Bearer ' + token } });

                const activeData = await activeRes.json();
                const upcomingData = await upcomingRes.json();
                const endedData = await endedRes.json();

                const active = activeData.elections || [];
                const upcoming = upcomingData.elections || [];
                const ended = endedData.elections || [];

                allElections = active.concat(upcoming, ended);

                // Update counts
                document.getElementById('activeCount').textContent = active.length;
                document.getElementById('upcomingCount').textContent = upcoming.length;
                document.getElementById('endedCount').textContent = ended.length;

                renderElections();
            } catch (error) {
                console.error('Error loading elections:', error);
                document.getElementById('electionsGrid').innerHTML =
                    '<div class="col-span-full text-center py-12">' +
                    '<i class="bx bx-error-circle text-4xl text-red-400 mb-4"></i>' +
                    '<p class="text-slate-400">Failed to load elections</p>' +
                    '<button id="retryBtn" class="mt-4 px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg">Retry</button>' +
                    '</div>';
                document.getElementById('retryBtn').addEventListener('click', loadElections);
            }
        }

        // Determine election type based on title/description
        function getElectionType(election) {
            const text = (election.title + ' ' + (election.description || '')).toLowerCase();
            if (text.includes('federal') || text.includes('presidential') || text.includes('congress') || text.includes('senate elections')) {
                return 'federal';
            } else if (text.includes('state') || text.includes('governor') || text.includes('assembly')) {
                return 'state';
            }
            return 'local';
        }

        // Set status filter
        function setStatusFilter(status, btn) {
            currentStatus = status;

            // Update tab styles
            document.querySelectorAll('#statusTabs .tab-btn').forEach(function (b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            renderElections();
        }

        // Set type filter
        function setTypeFilter(type, btn) {
            currentType = type;

            // Update chip styles
            document.querySelectorAll('#typeFilters .filter-chip').forEach(function (b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            renderElections();
        }

        // Render elections
        function renderElections() {
            var searchQuery = document.getElementById('searchInput').value.toLowerCase();

            var filtered = allElections.filter(function (election) {
                var matchesStatus = election.status === currentStatus;
                var matchesType = currentType === 'all' || getElectionType(election) === currentType;
                var matchesSearch = election.title.toLowerCase().includes(searchQuery) ||
                    (election.description || '').toLowerCase().includes(searchQuery);
                return matchesStatus && matchesType && matchesSearch;
            });

            var grid = document.getElementById('electionsGrid');
            var emptyState = document.getElementById('emptyState');

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            var html = '';
            for (var i = 0; i < filtered.length; i++) {
                var election = filtered[i];
                var type = getElectionType(election);
                var candidates = election.Candidates || [];
                var totalVotes = 0;
                for (var j = 0; j < candidates.length; j++) {
                    totalVotes += (candidates[j].vote_count || 0);
                }
                var endDate = new Date(election.end_time);
                var startDate = new Date(election.start_time);
                var now = new Date();

                var timeInfo = '';
                if (election.status === 'active') {
                    var daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    timeInfo = daysLeft > 0 ? daysLeft + ' days left' : 'Ending soon';
                } else if (election.status === 'upcoming') {
                    var daysUntil = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                    timeInfo = 'Starts in ' + daysUntil + ' days';
                } else {
                    timeInfo = 'Ended ' + endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }

                var actionButton = '';
                if (election.status === 'active') {
                    actionButton = '<a href="voting_interface.html?election=' + election.id + '" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white rounded-lg font-medium transition-all flex items-center justify-center">' +
                        '<i class="bx bx-vote mr-2"></i> Vote Now</a>';
                } else if (election.status === 'upcoming') {
                    actionButton = '<button disabled class="w-full py-3 bg-slate-600/50 text-slate-400 rounded-lg font-medium cursor-not-allowed flex items-center justify-center">' +
                        '<i class="bx bx-time-five mr-2"></i> Coming Soon</button>';
                } else {
                    actionButton = '<a href="election_results.html?election=' + election.id + '" class="w-full py-3 bg-gradient-to-r from-slate-600 to-slate-500 hover:from-slate-500 hover:to-slate-400 text-white rounded-lg font-medium transition-all flex items-center justify-center">' +
                        '<i class="bx bx-bar-chart-alt-2 mr-2"></i> View Results</a>';
                }

                html += '<div class="election-card glass-card border border-white/10 rounded-2xl overflow-hidden">' +
                    '<div class="p-6">' +
                    '<div class="flex justify-between items-start mb-4">' +
                    '<span class="type-badge type-' + type + '">' + type + '</span>' +
                    '<span class="status-badge status-' + election.status + '">' + election.status.charAt(0).toUpperCase() + election.status.slice(1) + '</span>' +
                    '</div>' +
                    '<h3 class="text-lg font-bold text-white mb-2">' + election.title + '</h3>' +
                    '<p class="text-slate-400 text-sm mb-4 line-clamp-2">' + (election.description || 'No description available') + '</p>' +
                    '<div class="flex items-center justify-between text-sm text-slate-400 mb-4">' +
                    '<span class="flex items-center"><i class="bx bx-group mr-1"></i> ' + candidates.length + ' candidates</span>' +
                    '<span class="flex items-center"><i class="bx bx-bar-chart mr-1"></i> ' + totalVotes.toLocaleString() + ' votes</span>' +
                    '</div>' +
                    '<div class="flex items-center text-sm text-slate-400 mb-4">' +
                    '<i class="bx bx-time-five mr-1"></i> ' + timeInfo +
                    '</div>' +
                    actionButton +
                    '</div>' +
                    '</div>';
            }

            grid.innerHTML = html;
        }
    </script>
</body>

</html>